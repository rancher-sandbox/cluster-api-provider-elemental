# Authentication & Authorization

This document describes the usage of the `Registration-Authorization` and `Authorization` headers when communicating with the [Elemental API](../README.md#elemental-api).

## Registration Tokens

Any ElementalHost that wants to register to an active registration, will need a registration token.  
This should be passed to the Elemental API using the `Registration-Authorization` header, as described in the [OpenAPI specs](../elemental-openapi.yaml).

Registration tokens are automatically generated by the controller whenever a registration is created:

```bash
cat << EOF | kubectl apply -f -
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: ElementalRegistration
metadata:
  name: my-registration
  namespace: default
spec:
  config:
    elemental:
      registration:
        tokenDuration: 0
EOF
```

After applying, the newly created registration will contain a new `token`:

```bash
kubectl get elementalregistration my-registration -o=jsonpath='{.spec.config.elemental.registration.token}'

eyJhbGciOiJFZERTQSIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJFbGVtZW50YWxSZWdpc3RyYXRpb25SZWNvbmNpbGVyIiwic3ViIjoiaHR0cDovLzE5Mi4xNjguMTIyLjEwOjMwMDA5L2VsZW1lbnRhbC92MS9uYW1lc3BhY2VzL2RlZmF1bHQvcmVnaXN0cmF0aW9ucy9teS1yZWdpc3RyYXRpb24iLCJhdWQiOlsiaHR0cDovLzE5Mi4xNjguMTIyLjEwOjMwMDA5L2VsZW1lbnRhbC92MS9uYW1lc3BhY2VzL2RlZmF1bHQvcmVnaXN0cmF0aW9ucy9teS1yZWdpc3RyYXRpb24iXSwibmJmIjoxNjk5ODc1NDYxLCJpYXQiOjE2OTk4NzU0NjF9.VK6jQ7MutSrb4RVT-w0PGd14MRZbJVoJXXyWd44l_tijC_IlSernkaZpa-KFTLn0XVyE6IcpPm4zYXlyAGYoAw
```

The token is in JWT format. You can inspect it using the web app at [jwt.io](https://jwt.io).  
By default registration tokens do not and should not expire.  
The registration tokens are normally shared with hosts during the provisioning phase and are used by the `elemental-agent` to register a new ElementalHost.  
Note that during the registration phase (`elemental-agent --register`), the `elemental-agent` will exchange its registration token for a fresh one, when fetching the remote ElementalRegistration to update (and override) the agent config file.  
For this reason issuing tokens with an expiration date will eventually impact the ability of the hosts to reset and re-register.  

You can generate a valid `elemental-agent` config file from any registration, using the conveniency `print_agent_config.sh` script from this repo (depends on `kubectl` and `yq`):

```bash
test/scripts/print_agent_config.sh -n default -r my-registration

agent:
  debug: false
  hostname:
    useExisting: false
  osPlugin: /usr/lib/elemental/plugins/elemental.so
  reconciliation: 10000000000
  workDir: /var/lib/elemental/agent
registration:
  token: eyJhbGciOiJFZERTQSIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJFbGVtZW50YWxSZWdpc3RyYXRpb25SZWNvbmNpbGVyIiwic3ViIjoiaHR0cDovLzE5Mi4xNjguMTIyLjEwOjMwMDA5L2VsZW1lbnRhbC92MS9uYW1lc3BhY2VzL2RlZmF1bHQvcmVnaXN0cmF0aW9ucy9teS1yZWdpc3RyYXRpb24iLCJhdWQiOlsiaHR0cDovLzE5Mi4xNjguMTIyLjEwOjMwMDA5L2VsZW1lbnRhbC92MS9uYW1lc3BhY2VzL2RlZmF1bHQvcmVnaXN0cmF0aW9ucy9teS1yZWdpc3RyYXRpb24iXSwibmJmIjoxNjk5ODc1NDYxLCJpYXQiOjE2OTk4NzU0NjF9.VK6jQ7MutSrb4RVT-w0PGd14MRZbJVoJXXyWd44l_tijC_IlSernkaZpa-KFTLn0XVyE6IcpPm4zYXlyAGYoAw
  tokenDuration: 0
  uri: http://192.168.122.10:30009/elemental/v1/namespaces/default/registrations/my-registration
```

### Registration signing key

Whenever a new registration is created, a signing private key is also auto-generated by the controller.  
The key is stored in a secret with the same name of the registration, within the same namespace as well.  

```bash
kubectl get secret my-registration -o yaml
apiVersion: v1
data:
  privKey: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1DNENBUUF3QlFZREsyVndCQ0lFSU1KZi95YWhicFlnU3VFaDBHaFpxR1hCWjNKcVZGQ29WQlFhY2NkZ1RCeGkKLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLQo=
kind: Secret
metadata:
  creationTimestamp: "2023-11-13T11:37:41Z"
  name: my-registration
  namespace: default
  ownerReferences:
  - apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
    controller: true
    kind: ElementalRegistration
    name: my-registration
    uid: 3d3e58bf-495f-4d63-a825-e4a02c224156
  resourceVersion: "37704"
  uid: c8e09eeb-cbb4-4482-9b78-9fbf90926594
type: Opaque
```

The key is an EdDSA private key, in PEM format.  
You can choose to let the controller generate its own registration signing key, or you can create one yourself.  

The ElementalRegistration also carries a reference to the signing key secret:

```bash
kubectl get elementalregistration my-registration -o=jsonpath='{.spec.privateKeyRef}'
{"name":"my-registration","namespace":"default","uid":"c8e09eeb-cbb4-4482-9b78-9fbf90926594"}
```

This reference can be optionally updated to a different secret, containing a PEM formatted EdDSA key in the `privKey` data value.  

### Registration token leaks

Registration tokens are sensitive secrets. Any valid and not-expired token will allow any actor to register a new ElementalHost, if they have access to the Elemental API.  
These tokens are also normally included in any installation media that was created to provision new machine, for example a bootable .iso or a raw image.  
If these tokens are leaked for any reason, it is possible to generate a new registration signing key, invalidating any previously issued token.  
**Note** that this will require to manually provide a new valid token to each already running and registered machine, by updating the agent config (`/etc/elemental/agent/config.yaml` by default).  

What to do in case of leaks:  

1. Delete the secret containing the signing key:

    ```bash
    kubectl delete secret my-registration
    ```

    After the deletion of the signing key, the registration API controller will error out when trying to register any new host.  
    **This already prevents new registrations, nullifying any leaked token.**  

1. Delete the Registration's `spec.privateKeyRef`:

    ```bash
    kubectl patch elementalregistration my-registration -p '{"spec":{"privateKeyRef":null}}' --type=merge
    ```

    At this point the registration controller should have generated a new secret containing a new signing key.  
    The Registration's `spec.privateKeyRef` should also be referencing the new secret by default.  

1. You can now generate a new valid token by deleting the previous registration token. A fresh one will be generated:  

    ```bash
    kubectl patch elementalregistration my-registration -p '{"spec":{"config":{"elemental":{"registration":{"token":""}}}}}' --type=merge
    ```

1. Last but not least, you should audit the existing `ElementalHosts` and verify that none of them registered after the leak occurred.  
   This can be achieved by sorting the `ElementalHosts` by creation date:  

   ```bash
   kubectl get elementalhost --sort-by=.medatada.creationTimestamp -o yaml
   ```

   You should also update the agent config on each host by providing a new valid token, so that the agent will be able to reset and re-register correctly.  

### Forbidding new registrations

While normally discouraged, it is possible to "freeze" a registration by forbidding new hosts from registering.  
This can be a valid scenario for example when no new provisioning or reset of existing hosts is expected to take place.  

A quick way to do this is to manually replace the registration token:  

```bash
kubectl patch elementalregistration my-registration -p '{"spec":{"config":{"elemental":{"registration":{"token":"disabled"}}}}}' --type=merge
```

The controller will not try to replace any existing string provided, even if not in the expected JWT format.  

Another way to achieve the same goal is to generate an already expired token.  
This can be controlled setting the `tokenDuration` value to `-1` for example.  

```bash
kubectl patch elementalregistration my-registration -p '{"spec":{"config":{"elemental":{"registration":{"token":"", "tokenDuration":-1}}}}}' --type=merge
```

## Host Authentication

When modifying hosts resources, the Elemental API expects a valid host token provided in the `Authorization` header.  
This is also documented in in the [OpenAPI specs](../elemental-openapi.yaml).  

Similarly to the registration tokens, host tokens are also in JWT format.  
The `elemental-agent` will always generate a new private signing key in a `private.key` file within its work directory.  
If no file exists, a new one is created, otherwise it's simply loaded.  
This gives the possibility of pre-creating a signing key before running `elemental-agent --register`.  
The key must be an EdDSA key in PEM format.  

When registering a new `ElementalHost`, the agent will pass the public key that should be used to validate its signature and also a signed JWT so that the controller can validate the request.  
After registration, you can inspect the `ElementalHost` to check the registered public key:  

```bash
kubectl get elementalhost m-ede4a577-0c4b-4325-a344-2fb7cb6a85c7 -o yaml
    [..cut..]
    spec:
      pubKey: |
        -----BEGIN PUBLIC KEY-----
        MCowBQYDK2VwAyEA3jGZyutpdZVLa0z1wWrLB+6i1uWCDoDftohgl2k7HqE=
        -----END PUBLIC KEY-----
```

### Host identity leaks

If a running host is compromised and the `private.key` file is leaked, it is possible to invalidate any further request signed by the key by deleting or replacing the ElementalHost's `spec.pubKey` field.  
If the host is recoverable, it is possible to manually generate a new `private.key` file in the agent's work directory, and update the related `ElementalHost` object with a valid `spec.pubKey` (in PEM format) that can be used to validate the new key signature.  
